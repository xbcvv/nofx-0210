# 量化系统选币过滤机制 (Coin Selection Pipeline)
> **文档属性:** 核心架构设计与防护指南 / 适用于 NoFx 交易引擎  
> **更新时间:** 本地缓存化与解耦重构后 (RightSide_Flow_Hunter_V4+)

---

## 1. 核心目标 (Why we need this)
原有的 AI500 和 OI_Top 等外部信号源虽然能精准捕捉全网“热度”，但无法完全阻挡**劣币入侵**。为了保护 AI 分析大脑不受扭曲盘面的污染（如上市不足10天的新币导致均线失真、深度不足的微盘币导致的画门插针），我们引入了物理切割的**双时间轴防封禁体系**（The Dual-Loop Architecture）。

本机制的宗旨是：**宁缺毋滥。绝不让一颗脏币流入 AI 的推演引擎。**为了实现极速过滤且保护 Binance API 不被封禁，我们将理论上的 8 大过滤条件拆迁划分为**三大阵营**。

---

## 2. 架构原理 (Architecture Design)

系统内部设立了一个独立微服务单例：`CoinFilterManager`（位于 `filter/coin_filter_manager.go`）。
此设计将过滤与引擎微观轮询（3~15 分钟）完全隔离开来，从根本上杜绝了对 Binance API 的高频 DDoS 风险，保证了主交易集群的绝对高可用。

### ⏳ 慢循环层（后台洗刷层 - 默认 30 分钟）
这是一个在后台常驻的定时守护进程 (`daemonLoop`)：
1. **聚合拉取**: 获取币安的 `/fapi/v1/ticker/24hr` （全球统一接口，权重极低。为应对上百个标的导致的巨大 payload，本层剥离主交易层 5s 快熔断机制，装备了专项 30s 免超时长连接 `http.Client`，杜绝一切由于请求超时造成的误杀）。
2. **本地入库**: 通过上述 1 次接口，就在内存中刷平了几百个合约的交易量、市值计算等。
3. **初指补充**: 每当市面上出现“陌生币”时，请求其首根周线/日线来记录出世时间，并将该“出生纸”永久落盘到 `data/listing_cache.json` 中，终身仅查 1 次。
4. **OI并流**: 对那些“交易量达标”的初步幸存者，单独请求实时 OI。

### ⚡ 快循环层（前台交易层 - 依赖前端配置）
1. AI 交易引擎被触发（如 每 3 分钟）。
2. **混合源聚合 (Mixed Pipeline)**：支持按需开关 AI500（引入 `AI500FetchAll` 全量获取）、币安本地 24H 交易额排行（`BinanceTopVolLimit` 提取热度）、OI 排行及静态监控名单。
3. 把这些海量名单送进 `CoinFilterManager.GetCleanCoins(raw, limit)` 的黑盒中。
4. **黑盒排雷裁决**: 依据后台刚算好的那张“生死簿”，淘汰掉深度不足、上市不足等脏币。
5. **全局截断交付**: 所有存活下来的干净币种将汇合去重，最后依靠 `BlackboxCutoffLimit` （统一黑盒截断数量）进行截断，固定向 AI 大脑投喂安全的候选列表，杜绝超长 Context 所导致的幻觉。

---

## 3. 过滤网“三大阵营”细则 (The 3-Tier Arsenal)

### 🗡️ 第一阵营：底层物理清洗网 (0 成本、防封禁、已实装)
这 3 条是最底层的硬核网关，执行在独立的慢循环内，任何标的未过关即刻斩杀：

1. **历史纵深防失真 (`MinListingDays >= 90`)** 
   - 过滤上市未满 3 个月的次新资产，防止其早期无序波动和 EMA(50) 物理层缺失导致的大模型幻觉。系统仅且一次拉取其最老的 日线 K 柱存入硬盘。
2. **深度红线 (`MinQuoteVolume24h >= 50,000,000 USDT`)**
   - 过去 24 小时内的真实成交额低于 5000 万美金的，直接判为死水，防止强庄插针爆破。通过 1 次 Ticker 接口拦截。
3. **持仓体量红线 (`MinOpenInterest >= 10,000,000 USDT`)**
   - 多空双方的博弈盘子如果不到一千万美金，没有大资金进场，不具备“量化吃鱼头”的肥膘基础。这顺带**等效证明了庞大流通市值**的要求。

### 🛡️ 第二阵营：外挂预留项 (依赖宏观量化环境 API)
针对【极端资金费率拦截】和【交易所下架观察标签(ST)拦截】。
- 当行情服务端（或未来 NoFxOS 更新字段后），这 2 项检查可直接通过单次 `/fapi/v1/exchangeInfo` 增设白名单判断器，在 `GetCleanCoins` 时仅需一键开启判定，即插即用，不增加 K 线请求负担。

### 🧠 第三阵营：顶级盘感审核网 (大语言模型裁决器)
这部分属于**战略机密**，绝不可用底层枯燥的数据暴力卡死（否则容易错失蓄力初期的牛股）。它们被完全注入在策略 `RightSide_Flow_Hunter.json` 的核心 Prompt 与开关内：

1. **基础波动率(ATR)监测：斩断无波动僵尸**
   - **底层支撑**：开启 `"enable_atr": true, "atr_periods": [14]`。系统拿到幸存精英名单后加载 ATR 指数给 AI。
   - **AI 执行**：通过提示词内的动能战法（“15m放量突破平台”及“偏离 EMA 距离考量 ATR 倍数”），AI 自行将那些指标呈干线水平的标的踢出进场位。
2. **相对 BTC 的强弱势裁定：斩断逆势弱鸡**
   - **底层支撑**：引擎架构永远强制并发拉取 `BTCUSDT` 全量数据当做北极星。
   - **AI 执行**：通过执行 `# 5. 决策流程 -> 终极审计 -> Q1 相对强度` 这条军规：“大盘狂涨它阴跌”，AI 立刻行使一票否决权 `>>> 驳回`。

---

## 4. 开发者维护与注意事项 (Operation & Maintenance)

### 🚨 注意事项（Caution!）
- **不要在交易主循环 `GetFullDecision` 中直接写死过滤 API**：绝不允许为了获取某个币的某项过滤指标，在快循环框架内并发发起百次的 HTTP GET，必会招致 `429 Too Many Requests`。
- **配置的修改**：若需放宽/紧缩阈值，请直接修改 `filter/coin_filter_manager.go` 中的 `DefaultFilterConfig` 结构体：
  ```go
  var DefaultFilterConfig = FilterConfig{
  	MinListingDays:    90,           // 天
  	MinQuoteVolume24h: 50_000_000,   // 5000w美金
  	MinOpenInterest:   10_000_000,   // 1000w美金
  }
  ```
- **配置与前端关联度**：目前前端通过三列式流水线架构管控所有源的流入配额。无论是 AI500 还是币安高热度，这是第一层大漏斗。这些初审名额一旦进入过滤层黑盒，存活名额将继续交由用户设定的 **BlackboxCutoffLimit** (黑盒截断) 进行收尾分配。即便你的 AI500 选项配给100个名额，倘若这时期只有40个干净标的通过审查，且黑盒截断设置为20，系统**只会挑前 20 提交给 AI 模型**。决不允许残次品进入！

# 量化系统选币过滤机制 (Coin Selection Pipeline)
> **文档属性:** 核心架构设计与防护指南 / 适用于 NoFx 交易引擎  
> **更新时间:** 本地缓存化与解耦重构后 (RightSide_Flow_Hunter_V4+)

---

## 1. 核心目标 (Why we need this)
原有的 AI500 和 OI_Top 等外部信号源虽然能精准捕捉全网“热度”，但无法完全阻挡**劣币入侵**。为了保护 AI 分析大脑不受扭曲盘面的污染（如上市不足10天的新币导致均线失真、深度不足的微盘币导致的画门插针），我们引入了物理切割的**双时间轴防封禁体系**（The Dual-Loop Architecture）。

本机制的宗旨是：**宁缺毋滥。绝不让一颗脏币流入 AI 的推演引擎。**为了实现极速过滤且保护 Binance API 不被封禁，我们将理论上的 8 大过滤条件拆迁划分为**三大阵营**。

---

## 2. 架构原理 (Architecture Design)

系统内部设立了一个独立微服务单例：`CoinFilterManager`（位于 `filter/coin_filter_manager.go`）。
此设计将过滤与引擎微观轮询（3~15 分钟）完全隔离开来，从根本上杜绝了对 Binance API 的高频 DDoS 风险，保证了主交易集群的绝对高可用。

### ⏳ 慢循环层（后台洗刷层 - 默认 30 分钟）
这是一个在后台常驻的定时守护进程 (`daemonLoop`)：
1. **聚合拉取**: 获取币安的 `/fapi/v1/ticker/24hr` （全球统一接口，权重极低。为应对上百个标的导致的巨大 payload，本层剥离主交易层 5s 快熔断机制，装备了专项 30s 免超时长连接 `http.Client`，杜绝一切由于请求超时造成的误杀）。
2. **本地入库**: 通过上述 1 次接口，就在内存中刷平了几百个合约的交易量、市值计算等。
3. **初指补充**: 每当市面上出现“陌生币”时，请求其首根周线/日线来记录出世时间，并将该“出生纸”永久落盘到 `data/listing_cache.json` 中，终身仅查 1 次。
4. **OI并流**: 对那些“交易量达标”的初步幸存者，单独请求实时 OI。

### ⚡ 快循环层（前台交易层 - 依赖前端配置）
1. AI 交易引擎被触发（如 每 3 分钟）。
2. **混合源聚合 (Mixed Pipeline)**：支持按需开关 AI500（引入 `AI500FetchAll` 全量获取）、币安本地 24H 交易额排行（`BinanceTopVolLimit` 提取热度）、OI 排行及静态监控名单。
3. 把这些海量名单送进 `CoinFilterManager.GetCleanCoins(raw, limit)` 的黑盒中。
4. **黑盒排雷裁决**: 依据后台刚算好的那张“生死簿”，淘汰掉深度不足、上市不足等脏币。
5. **全局截断交付**: 所有存活下来的干净币种将汇合去重，最后依靠 `BlackboxCutoffLimit` （统一黑盒截断数量）进行截断，固定向 AI 大脑投喂安全的候选列表，杜绝超长 Context 所导致的幻觉。

---

## 3. 过滤网“三大阵营”细则 (The 3-Tier Arsenal)

### 🗡️ 第一阵营：底层物理清洗网 (0 成本、防封禁、已实装)
这 3 条是最底层的硬核网关，执行在独立的慢循环内，任何标的未过关即刻斩杀：

1. **历史纵深防失真 (`MinListingDays >= 90`)** 
   - 过滤上市未满 3 个月的次新资产，防止其早期无序波动和 EMA(50) 物理层缺失导致的大模型幻觉。系统仅且一次拉取其最老的 日线 K 柱存入硬盘。
2. **深度红线 (`MinQuoteVolume24h >= 50,000,000 USDT`)**
   - 过去 24 小时内的真实成交额低于 5000 万美金的，直接判为死水，防止强庄插针爆破。通过 1 次 Ticker 接口拦截。
3. **持仓体量红线 (`MinOpenInterest >= 10,000,000 USDT`)**
   - 多空双方的博弈盘子如果不到一千万美金，没有大资金进场，不具备“量化吃鱼头”的肥膘基础。这顺带**等效证明了庞大流通市值**的要求。

### 🛡️ 第二阵营：外挂预留项 (依赖宏观量化环境 API)
针对【极端资金费率拦截】和【交易所下架观察标签(ST)拦截】。
- 当行情服务端（或未来 NoFxOS 更新字段后），这 2 项检查可直接通过单次 `/fapi/v1/exchangeInfo` 增设白名单判断器，在 `GetCleanCoins` 时仅需一键开启判定，即插即用，不增加 K 线请求负担。

### 🧠 第三阵营：顶级盘感审核网 (大语言模型裁决器)
这部分属于**战略机密**，绝不可用底层枯燥的数据暴力卡死（否则容易错失蓄力初期的牛股）。它们被完全注入在策略 `RightSide_Flow_Hunter.json` 的核心 Prompt 与开关内：

1. **基础波动率(ATR)监测：斩断无波动僵尸**
   - **底层支撑**：开启 `"enable_atr": true, "atr_periods": [14]`。系统拿到幸存精英名单后加载 ATR 指数给 AI。
   - **AI 执行**：通过提示词内的动能战法（“15m放量突破平台”及“偏离 EMA 距离考量 ATR 倍数”），AI 自行将那些指标呈干线水平的标的踢出进场位。
2. **相对 BTC 的强弱势裁定：斩断逆势弱鸡**
   - **底层支撑**：引擎架构永远强制并发拉取 `BTCUSDT` 全量数据当做北极星。
   - **AI 执行**：通过执行 `# 5. 决策流程 -> 终极审计 -> Q1 相对强度` 这条军规：“大盘狂涨它阴跌”，AI 立刻行使一票否决权 `>>> 驳回`。

---

## 4. 开发者维护与注意事项 (Operation & Maintenance)

### 🚨 注意事项（Caution!）
- **不要在交易主循环 `GetFullDecision` 中直接写死过滤 API**：绝不允许为了获取某个币的某项过滤指标，在快循环框架内并发发起百次的 HTTP GET，必会招致 `429 Too Many Requests`。
- **配置的修改**：若需放宽/紧缩阈值，请直接修改 `filter/coin_filter_manager.go` 中的 `DefaultFilterConfig` 结构体：
  ```go
  var DefaultFilterConfig = FilterConfig{
  	MinListingDays:    90,           // 天
  	MinQuoteVolume24h: 50_000_000,   // 5000w美金
  	MinOpenInterest:   10_000_000,   // 1000w美金
  }
  ```
- **配置与前端关联度**：目前前端通过三列式流水线架构管控所有源的流入配额。无论是 AI500 还是币安高热度，这是第一层大漏斗。这些初审名额一旦进入过滤层黑盒，存活名额将继续交由用户设定的 **BlackboxCutoffLimit** (黑盒截断) 进行收尾分配。即便你的 AI500 选项配给100个名额，倘若这时期只有40个干净标的通过审查，且黑盒截断设置为20，系统**只会挑前 20 提交给 AI 模型**。决不允许残次品进入！

### 📁 核心关联文件
- `filter/coin_filter_manager.go`：独立解耦的核心裁决中心。
- `market/api_client.go`：底层封装的 `GetAll24hrTickers` 大全量数据流。
- `data/listing_cache.json`：由系统自动生成的币种“出生纸”永久保存库（自动建立）。

---
> **V1.1.5 架构稳定性更新**: 彻底重构了 `CoinFilterManager` 后台更新时的读写锁临界区，移除了由于初始化网络超时补传时触发读写锁（`sync.RWMutex`）自重入导致的偶发死锁风险，根除了半小时僵死症状，确保了全天候并发安全性。
> 
> **V1.1.7 主流剥离与 A+B 碎选抽检**: 优化混合模式下 `BlackboxCutoffLimit` 被高额 Volume 绝对值霸榜的缺陷。动态池将自动屏蔽大饼以太系以预留生态位，并创新性启用了 `[Top A位绝对热度头部 + Random B位腰部摸彩]` 相结合的发审流，在不流失稳定胜率的前提下显著提高了 AI 捕捉百倍山寨 Alpha 的概率。
