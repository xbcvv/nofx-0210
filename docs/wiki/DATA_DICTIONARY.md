# 📖 交易数据字典与规则 (Data Dictionary & Rules)

本文档是系统 System Prompt 中数据字典的完整参考。
为了节省 Token，实际发送给 AI 的 System Prompt 仅包含核心字段的简要定义（标记为 ✅）。其他字段（标记为 ℹ️）虽然数据本身会传给 AI，但 AI 会基于其常识理解，不再在 System Prompt 中重复解释。

> **图例说明**:
> *   ✅ **System Prompt**: 该字段的定义显式包含在发送给 AI 的提示词中。
> *   ℹ️ **Implicit (隐式)**: 该字段的数据会传给 AI，但定义未包含在提示词中（依赖 AI 常识）。

## 1. 字段定义 (Field Definitions)

### 账户指标 (Account)
| 状态 | 英文 Key | 中文含义 | 详细说明 | 公式/备注 |
| :---: | :--- | :--- | :--- | :--- |
| ✅ | **Equity** | 总权益 | 账户净值，包含未实现盈亏 (Available + Unrealized PnL) | `可用余额 + 未实现盈亏` |
| ✅ | **Balance** | 可用余额 | 可用于开仓的资金 (不含已用保证金) | `初始资金 + 已实现盈亏` |
| ✅ | **Margin** | 保证金使用率 | 已用保证金占总权益的比例 (Used Margin / Equity) | `已用保证金 / 总权益 × 100` |
| ✅ | **PnL** | 总收益率 | 账户自启动以来的总投资回报率 | `(总权益 - 初始) / 初始 × 100` |

### 交易指标 (Trade)
| 状态 | 英文 Key | 中文含义 | 详细说明 | 公式/备注 |
| :---: | :--- | :--- | :--- | :--- |
| ✅ | **Entry** | 进场均价 | 开仓的平均价格 | - |
| ✅ | **Exit** | 出场均价 | 平仓的平均价格 | - |
| ✅ | **Profit** | 已实现盈亏 | 该笔交易的实际盈利金额 (USDT) | 正值=盈利，负值=亏损 |
| ✅ | **HoldDuration** | 持仓时长 | 从开仓到平仓经历的时间 | AI根据时间戳自动计算 |
| ℹ️ | **RiskUSD** | 风险金额 | 单次交易的最大风险金额 | 用于风控计算 |
| ℹ️ | **Confidence** | 置信度 | AI决策的信心程度 (0-100) | AI输出值 |
| ℹ️ | **PnL%** | 盈亏百分比 | 已平仓交易的收益率 | `Profit / 保证金` |

### 持仓指标 (Position)
| 状态 | 英文 Key | 中文含义 | 详细说明 | 公式/备注 |
| :---: | :--- | :--- | :--- | :--- |
| ✅ | **UnrealizedPnL** | 未实现盈亏 | 当前持仓的浮动盈亏 | `(当前价 - 进场价) * 方向` |
| ✅ | **PeakPnL** | 历史峰值盈亏 | 该持仓曾达到的最高浮盈% | **核心策略字段**，用于移动止盈 |
| ✅ | **Drawdown** | 利润回撤 | 当前盈亏距离峰值盈亏的回撤幅度 | `当前PnL - PeakPnL` |
| ✅ | **LiqPrice** | 强平价格 | 预估爆仓价格 | 0 表示无风险 |
| ✅ | **Action** | 交易动作 | `open_long/short`, `close`, `hold` 等 | AI 输出指令 |
| ✅ | **ClosePercentage**| 平仓比例 | 仅配合 `partial_close` 使用 | 0.5 = 平仓 50% |
| ℹ️ | **Symbol** | 交易对 | 如 BTCUSDT | - |
| ℹ️ | **Leverage** | 杠杆倍数 | 当前持仓的杠杆倍数 | 如 3x, 5x |
| ℹ️ | **StopLoss** | 止损价格 | 设置的硬止损位 | - |
| ℹ️ | **TakeProfit** | 止盈价格 | 设置的目标止盈位 | - |
| ℹ️ | **Margin** | 占用保证金 | 该仓位锁定的保证金金额 | `仓位价值 / 杠杆` |

### 寄存器/记忆 (Register)
| 状态 | 英文 Key | 中文含义 | 详细说明 | 公式/备注 |
| :---: | :--- | :--- | :--- | :--- |
| ✅ | **Cycle** | 决策周期 | 决策序列号，用于追踪连续性 | - |
| ✅ | **MarketRegime** | 市场状态 | AI 对当前市场环境的定性 | 如 Bull, Bear, Ranging |
| ✅ | **ExecutionStatus**| 执行状态 | 上一周期的决策是否执行成功 | Success / Failed |
| ℹ️ | **Decisions** | 历史决策 | 过去周期做出的具体交易决策列表 | 包含 Action, Reason, EntryPrice 等 |

### 市场数据 (Market Data)
| 状态 | 英文 Key | 中文含义 | 详细说明 | 公式/备注 |
| :---: | :--- | :--- | :--- | :--- |
| ℹ️ | **OI** | 持仓量 | 未平仓合约总价值 | 资金流向核心指标 |
| ℹ️ | **OIChange** | 持仓量变化 | 1小时内持仓量的变化 | 判断资金流入流出 |
| ℹ️ | **Volume** | 成交量 | 该时间段的交易量 | - |

## 2. 核心规则 (Core Rules)

### OI (持仓量) 逻辑
| 现象 | 含义 | 市场解读 |
| :--- | :--- | :--- |
| **OI↑ + Price↑** | Bull Inflow | **多头资金流入**：看涨，趋势增强 |
| **OI↑ + Price↓** | Bear Inflow | **空头资金流入**：看跌，抛压增强 |
| **OI↓ + Price↑** | Shorts Covering | **空头回补**：空头止损离场，可能反转或反弹 |
| **OI↓ + Price↓** | Longs Liquidation | **多头平仓**：多头止损离场，可能反转或回调 |

### 风险控制 (Risk Management)
*(以下规则已从 System Prompt 硬编码中移除，完全由用户在策略配置的 `prompt_sections.entry_standards` 中定义)*

*   **Max Margin (最大仓位)**: 建议控制在 30%-50% 以内。
*   **Stop Loss (硬止损)**: 建议每笔交易设置明确的止损位 (如 -5% 或 ATR 倍数)。
*   **Daily Loss (日亏损限额)**: 建议设置日亏损熔断机制 (如 -10%)。

### 策略原则 (Strategy)
*(以下规则已从 System Prompt 硬编码中移除，完全由用户在策略配置的 `prompt_sections.entry_standards` 中定义)*

*   **Scale In**: 建议采用金字塔加仓法 (只在盈利时加仓)。
*   **Trailing Stop (移动止盈)**: 建议基于 PeakPnL 进行动态回撤止盈 (如回撤 20%-30% 时止盈)。
